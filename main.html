<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPower | Modern Power Analysis Tool</title>
    
    <!-- Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PyScript (Python Runtime) -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Matplotlib image adjustment */
        #plot-area img { width: 100%; height: auto; border-radius: 8px; }
        .input-group label { font-size: 0.75rem; font-weight: 600; color: #4b5563; display: block; margin-bottom: 0.25rem; }
        .input-group input, .input-group select { width: 100%; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.625rem; font-size: 0.875rem; transition: border-color 0.15s; }
        .input-group input:focus, .input-group select:focus { border-color: #3b82f6; outline: none; ring: 2px solid #93c5fd; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600 font-semibold">Python環境を構築中... (初回は時間がかかります)</p>
    </div>

    <!-- Main Layout -->
    <div class="flex h-screen flex-col md:flex-row overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-white border-r border-gray-200 flex flex-col z-10 shadow-sm shrink-0">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-2xl font-bold text-blue-600 tracking-tight">WebPower</h1>
                <p class="text-xs text-gray-400 mt-1">HCI & Psych Statistics</p>
            </div>
            
            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Test Family</p>
                
                <button onclick="switchTest('ttest')" id="btn-ttest" class="nav-btn w-full text-left px-4 py-3 rounded-lg bg-blue-50 text-blue-700 font-medium transition-colors">
                    t-tests (t検定)
                </button>
                <button onclick="switchTest('anova')" id="btn-anova" class="nav-btn w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">
                    F-tests (ANOVA)
                </button>
                <button onclick="switchTest('correlation')" id="btn-correlation" class="nav-btn w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">
                    Correlation (相関)
                </button>
            </nav>
            
            <div class="p-4 border-t border-gray-100 text-xs text-gray-400 text-center">
                Powered by PyScript & statsmodels
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative w-full">
            
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center shadow-sm z-10">
                <div>
                    <h2 id="header-title" class="text-xl font-bold text-gray-800">t-tests (Means)</h2>
                    <p class="text-sm text-gray-500">A priori: Compute required sample size</p>
                </div>
                <button id="calc-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md transition-transform transform active:scale-95 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    Calculate
                </button>
            </header>

            <!-- Scrollable Content Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    <!-- Input Section (Left) -->
                    <div class="lg:col-span-4 space-y-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-sm font-bold text-gray-900 uppercase mb-4 border-b pb-2">Parameters</h3>
                            
                            <!-- Dynamic Inputs -->
                            <div id="dynamic-inputs" class="space-y-4">
                                <!-- Default inputs injected here -->
                            </div>
                        </div>

                        <!-- Effect Size Helper -->
                        <div class="bg-blue-50 rounded-xl p-4 border border-blue-100 text-sm text-blue-800">
                            <p class="font-bold mb-1">Effect Size Conventions:</p>
                            <ul class="list-disc list-inside space-y-1 text-blue-700 text-xs" id="effect-conventions">
                                <li>Small: 0.2</li>
                                <li>Medium: 0.5</li>
                                <li>Large: 0.8</li>
                            </ul>
                            <p class="mt-2 text-xs text-blue-600 italic">
                                *HCI研究ではMedium (0.5 or 0.25) が基準となることが多いです。
                            </p>
                        </div>
                    </div>

                    <!-- Output Section (Right) -->
                    <div class="lg:col-span-8 space-y-6">
                        
                        <!-- Numerical Results -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-sm font-bold text-gray-900 uppercase mb-4">Results</h3>
                            <div id="result-display" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-100">
                                    <span class="block text-gray-500 text-xs uppercase">Total Sample Size</span>
                                    <span id="res-n" class="text-3xl font-bold text-blue-600">-</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-100">
                                    <span class="block text-gray-500 text-xs uppercase">Actual Power</span>
                                    <span id="res-power" class="text-3xl font-bold text-green-600">-</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-100">
                                    <span class="block text-gray-500 text-xs uppercase">Description</span>
                                    <span id="res-crit" class="text-sm font-medium text-gray-700">-</span>
                                </div>
                            </div>
                            <div id="error-msg" class="hidden mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100"></div>
                        </div>

                        <!-- Graph Area -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-sm font-bold text-gray-900 uppercase mb-4">Power Curve</h3>
                            <div id="plot-area" class="w-full flex justify-center items-center min-h-[350px] bg-white">
                                <p class="text-gray-400 text-sm">Click "Calculate" to generate plot</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden Input Templates -->
    
    <!-- T-TEST -->
    <template id="tmpl-ttest">
        <div class="input-group">
            <label>Type of t-test</label>
            <select id="sub-type">
                <option value="ind">Independent means (2 groups)</option>
                <option value="paired">Matched pairs (対応あり)</option>
                <option value="one">One sample case</option>
            </select>
        </div>
        <div class="input-group">
            <label>Tail (検定の方向)</label>
            <select id="tail-type">
                <option value="two-sided">Two-tailed (両側)</option>
                <option value="one-sided">One-tailed (片側)</option>
            </select>
        </div>
        <div class="input-group">
            <label>Effect Size ($d$)</label>
            <input type="number" id="effect_size" value="0.5" step="0.05">
        </div>
        <div class="input-group">
            <label>$\alpha$ err prob</label>
            <input type="number" id="alpha" value="0.05" step="0.01">
        </div>
        <div class="input-group">
            <label>Power ($1-\beta$)</label>
            <input type="number" id="power" value="0.80" step="0.05" max="0.99">
        </div>
        <div id="ratio-container" class="input-group">
            <label>Allocation ratio N2/N1</label>
            <input type="number" id="ratio" value="1" step="0.1">
        </div>
    </template>

    <!-- ANOVA (Expanded) -->
    <template id="tmpl-anova">
        <div class="input-group">
            <label>Type of F-test</label>
            <select id="sub-type-anova">
                <option value="oneway">One-way ANOVA (Fixed effects)</option>
                <option value="rm">Repeated Measures: Within factors (反復測定)</option>
                <option value="factorial">Factorial ANOVA: Interaction (交互作用)</option>
            </select>
        </div>
        <div class="input-group">
            <label>Effect Size ($f$)</label>
            <input type="number" id="effect_size" value="0.25" step="0.05">
        </div>
        <div class="input-group">
            <label>$\alpha$ err prob</label>
            <input type="number" id="alpha" value="0.05" step="0.01">
        </div>
        <div class="input-group">
            <label>Power ($1-\beta$)</label>
            <input type="number" id="power" value="0.80" step="0.05" max="0.99">
        </div>
        
        <!-- Dynamic Fields for ANOVA Types -->
        <div class="input-group">
            <label>Number of groups</label>
            <input type="number" id="n_groups" value="3" step="1" min="1">
            <small class="text-xs text-gray-400">Total groups or cells</small>
        </div>
        
        <!-- RM Specific -->
        <div id="anova-rm-fields" style="display:none;" class="space-y-4 pt-2 border-t border-gray-100">
            <div class="input-group">
                <label>Number of measurements (Repetitions)</label>
                <input type="number" id="n_reps" value="4" step="1" min="2">
            </div>
            <div class="input-group">
                <label>Corr. among rep measures ($\rho$)</label>
                <input type="number" id="corr_reps" value="0.5" step="0.1" max="0.99">
                <small class="text-xs text-gray-400 text-red-400">*G*Power logic approximation currently ignores this for simplicity</small>
            </div>
            <div class="input-group">
                <label>Nonsphericity correction ($\epsilon$)</label>
                <input type="number" id="epsilon" value="1.0" step="0.1" max="1.0" min="0.1">
                <small class="text-xs text-gray-400">1.0 = Perfect Sphericity</small>
            </div>
        </div>

        <!-- Factorial Specific -->
        <div id="anova-factorial-fields" style="display:none;" class="space-y-4 pt-2 border-t border-gray-100">
            <div class="input-group">
                <label>Numerator df ($df_{effect}$)</label>
                <input type="number" id="df_num" value="1" step="1" min="1">
                <small class="text-xs text-gray-400">For 2x2 Interaction: df=1. For 2x3: df=2.</small>
            </div>
        </div>
    </template>

    <!-- CORRELATION -->
    <template id="tmpl-correlation">
        <div class="input-group">
            <label>Correlation ($\rho$)</label>
            <input type="number" id="effect_size" value="0.3" step="0.1">
            <small class="text-gray-400 text-xs">H0: &rho; = 0</small>
        </div>
        <div class="input-group">
            <label>$\alpha$ err prob</label>
            <input type="number" id="alpha" value="0.05" step="0.01">
        </div>
        <div class="input-group">
            <label>Power ($1-\beta$)</label>
            <input type="number" id="power" value="0.80" step="0.05" max="0.99">
        </div>
        <div class="input-group">
            <label>Tail</label>
            <select id="tail-type">
                <option value="two-sided">Two-tailed</option>
                <option value="one-sided">One-tailed</option>
            </select>
        </div>
    </template>

    <!-- Python Configuration -->
    <py-config>
        packages = ["statsmodels", "scipy", "numpy", "matplotlib"]
    </py-config>

    <!-- UI Logic (JavaScript) -->
    <script>
        window.currentTest = 'ttest';

        document.addEventListener('DOMContentLoaded', () => {
            renderInputs('ttest');
        });

        function switchTest(testName) {
            window.currentTest = testName;
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = "nav-btn w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors";
            });
            document.getElementById(`btn-${testName}`).className = "nav-btn w-full text-left px-4 py-3 rounded-lg bg-blue-50 text-blue-700 font-medium transition-colors";
            renderInputs(testName);
        }

        function renderInputs(testName) {
            const container = document.getElementById('dynamic-inputs');
            const tmpl = document.getElementById(`tmpl-${testName}`);
            container.innerHTML = tmpl.innerHTML;

            const header = document.getElementById('header-title');
            const hints = document.getElementById('effect-conventions');
            
            if (testName === 'ttest') {
                header.textContent = "t-tests (Means)";
                hints.innerHTML = "<li>Small: 0.2</li><li>Medium: 0.5</li><li>Large: 0.8</li>";
                document.getElementById('sub-type').addEventListener('change', (e) => {
                    const ratioInput = document.getElementById('ratio-container');
                    if (ratioInput) ratioInput.style.display = e.target.value === 'ind' ? 'block' : 'none';
                });
            } else if (testName === 'anova') {
                header.textContent = "F-tests (ANOVA)";
                hints.innerHTML = "<li>Small: 0.10</li><li>Medium: 0.25</li><li>Large: 0.40</li>";
                
                // Add listener for ANOVA sub-types
                const subType = document.getElementById('sub-type-anova');
                const rmFields = document.getElementById('anova-rm-fields');
                const factFields = document.getElementById('anova-factorial-fields');
                
                const updateAnovaFields = () => {
                    if(!subType) return;
                    rmFields.style.display = 'none';
                    factFields.style.display = 'none';
                    if (subType.value === 'rm') {
                        rmFields.style.display = 'block';
                    } else if (subType.value === 'factorial') {
                        factFields.style.display = 'block';
                    }
                };
                
                if(subType){
                    subType.addEventListener('change', updateAnovaFields);
                    updateAnovaFields(); // Init
                }

            } else if (testName === 'correlation') {
                header.textContent = "Correlation (Pearson's r)";
                hints.innerHTML = "<li>Small: 0.1</li><li>Medium: 0.3</li><li>Large: 0.5</li>";
            }
        }
    </script>

    <!-- Python Logic -->
    <py-script>
        import js
        import numpy as np
        import matplotlib.pyplot as plt
        from statsmodels.stats.power import TTestIndPower, TTestPower
        from pyodide.ffi import create_proxy
        from scipy import stats
        import math
        from pyscript import display

        def on_load():
            loading = js.document.getElementById("loading")
            loading.style.display = "none"

        js.window.setTimeout(create_proxy(on_load), 100)

        def get_value(id, default=0.0):
            try:
                el = js.document.getElementById(id)
                if el: return float(el.value)
                return default
            except: return default

        def get_str(id):
            try: return js.document.getElementById(id).value
            except: return ""

        def run_analysis(event):
            test_family = js.window.currentTest
            error_div = js.document.getElementById("error-msg")
            error_div.style.display = "none"
            
            # Initialize core variables
            alpha = get_value("alpha", 0.05)
            target_power = get_value("power", 0.8)
            effect_size = get_value("effect_size", 0.5)
            
            n_result = 0
            actual_power = 0
            desc = ""
            
            # Initialize plot variables
            plot_obj = None
            plot_kwargs = {}
            
            # For Manual Plotting of ANOVA
            plot_anova_mode = None 
            plot_params = {}

            try:
                # ---------------------
                # T-TESTS
                # ---------------------
                if test_family == 'ttest':
                    # FIX: Match ID with HTML (sub-type, not sub_type)
                    sub_type = get_str("sub-type")
                    tail = get_str("tail-type")
                    alternative = 'two-sided' if tail == 'two-sided' else 'larger'
                    
                    if sub_type == 'ind':
                        ratio = get_value("ratio", 1.0)
                        analysis = TTestIndPower()
                        n1 = analysis.solve_power(effect_size=effect_size, nobs1=None, alpha=alpha, power=target_power, ratio=ratio, alternative=alternative)
                        n1 = math.ceil(n1)
                        n2 = math.ceil(n1 * ratio)
                        n_result = n1 + n2
                        actual_power = analysis.solve_power(effect_size=effect_size, nobs1=n1, alpha=alpha, ratio=ratio, alternative=alternative)
                        desc = f"Group 1: {n1}, Group 2: {n2}"
                        plot_obj = analysis
                        plot_kwargs = {'effect_size': effect_size, 'alpha': alpha, 'ratio': ratio, 'alternative': alternative}
                        
                    else: # Paired or One-sample
                        analysis = TTestPower()
                        n = analysis.solve_power(effect_size=effect_size, nobs=None, alpha=alpha, power=target_power, alternative=alternative)
                        n_result = math.ceil(n)
                        actual_power = analysis.solve_power(effect_size=effect_size, nobs=n_result, alpha=alpha, alternative=alternative)
                        desc = "Total pairs/samples"
                        plot_obj = analysis
                        plot_kwargs = {'effect_size': effect_size, 'alpha': alpha, 'alternative': alternative}

                # ---------------------
                # ANOVA (All types use Manual SCIPY to ensure reliability)
                # ---------------------
                elif test_family == 'anova':
                    # FIX: Match ID with HTML (sub-type-anova, not sub_type_anova)
                    sub_type_anova = get_str("sub-type-anova")
                    n_groups = int(get_value("n_groups", 3))
                    
                    if sub_type_anova == 'oneway':
                        # One-way ANOVA
                        # df1 = k - 1
                        # df2 = N - k
                        # ncp = f^2 * N
                        
                        def solve_oneway(n):
                            if n <= n_groups: return 0
                            df1 = n_groups - 1
                            df2 = n - n_groups
                            ncp = (effect_size ** 2) * n
                            f_crit = stats.f.ppf(1 - alpha, df1, df2)
                            return stats.ncf.sf(f_crit, df1, df2, ncp)

                        for n in range(n_groups + 2, 5000):
                            p = solve_oneway(n)
                            if p >= target_power:
                                n_result = n
                                actual_power = p
                                break
                        
                        desc = f"Total N (Groups: {n_groups})"
                        plot_anova_mode = 'oneway'
                        plot_params = {'n_groups': n_groups, 'df1': n_groups - 1}

                    elif sub_type_anova == 'factorial':
                        # Factorial (Interaction)
                        df_num = int(get_value("df_num", 1))
                        
                        def solve_factorial(n):
                            if n <= n_groups: return 0
                            df_denom = n - n_groups
                            ncp = (effect_size ** 2) * n 
                            f_crit = stats.f.ppf(1 - alpha, df_num, df_denom)
                            return stats.ncf.sf(f_crit, df_num, df_denom, ncp)

                        for n in range(n_groups + 2, 5000):
                            p = solve_factorial(n)
                            if p >= target_power:
                                n_result = n
                                actual_power = p
                                break
                        
                        desc = f"Total N (Cells: {n_groups}, df_eff: {df_num})"
                        plot_anova_mode = 'factorial'
                        plot_params = {'n_groups': n_groups, 'df_num': df_num}

                    elif sub_type_anova == 'rm':
                        # Repeated Measures
                        m_reps = int(get_value("n_reps", 4))
                        epsilon = get_value("epsilon", 1.0)
                        
                        def solve_rm(n):
                            if n <= n_groups: return 0
                            df1 = (m_reps - 1) * epsilon
                            df2 = (n - n_groups) * (m_reps - 1) * epsilon
                            ncp = (effect_size ** 2) * n * epsilon
                            f_crit = stats.f.ppf(1 - alpha, df1, df2)
                            return stats.ncf.sf(f_crit, df1, df2, ncp)

                        for n in range(n_groups + 2, 5000):
                            p = solve_rm(n)
                            if p >= target_power:
                                n_result = n
                                actual_power = p
                                break
                        
                        desc = f"Total N (Reps: {m_reps}, ε: {epsilon})"
                        plot_anova_mode = 'rm'
                        plot_params = {'n_groups': n_groups, 'm_reps': m_reps, 'epsilon': epsilon}

                # ---------------------
                # CORRELATION
                # ---------------------
                elif test_family == 'correlation':
                    tail = get_str("tail-type")
                    
                    def solve_corr_n(r, a, p_target, tail_mode):
                        if r == 0: return 0,0
                        for n in range(4, 5000):
                            z = 0.5 * np.log((1+r)/(1-r))
                            se = 1 / np.sqrt(n - 3)
                            z_crit = stats.norm.ppf(1 - a/2) if tail_mode == 'two-sided' else stats.norm.ppf(1 - a)
                            delta = abs(z) / se
                            calc_p = stats.norm.cdf(delta - z_crit)
                            if calc_p >= p_target:
                                return n, calc_p
                        return 5000, 0
                    
                    n_result, actual_power = solve_corr_n(effect_size, alpha, target_power, tail)
                    desc = "Total N"

                # ---------------------
                # UPDATE UI
                # ---------------------
                js.document.getElementById("res-n").innerText = str(int(n_result))
                js.document.getElementById("res-power").innerText = f"{actual_power:.4f}"
                js.document.getElementById("res-crit").innerText = desc

                # ---------------------
                # PLOTTING
                # ---------------------
                fig, ax = plt.subplots(figsize=(6, 4))
                
                center_n = n_result if n_result > 10 else 20
                ns = np.linspace(max(5, center_n * 0.5), center_n * 1.5, 40)
                powers = []
                
                if plot_obj:
                    # T-Test uses statsmodels object
                    for n_val in ns:
                        if sub_type == 'ind':
                            p_val = plot_obj.solve_power(nobs1=n_val/2, **plot_kwargs)
                        else:
                            p_val = plot_obj.solve_power(nobs=n_val, **plot_kwargs)
                        powers.append(p_val)

                elif test_family == 'correlation':
                    # Correlation manual plot
                    tail = get_str("tail-type")
                    for n_val in ns:
                        z = 0.5 * np.log((1+effect_size)/(1-effect_size))
                        se = 1 / np.sqrt(n_val - 3)
                        z_crit = stats.norm.ppf(1 - alpha/2) if tail == 'two-sided' else stats.norm.ppf(1 - alpha)
                        delta = abs(z) / se
                        powers.append(stats.norm.cdf(delta - z_crit))
                
                elif test_family == 'anova':
                    # All ANOVA plots are manual now
                    n_groups = plot_params.get('n_groups', 3)
                    
                    for n_val in ns:
                        if n_val <= n_groups: 
                            powers.append(0)
                            continue
                            
                        if plot_anova_mode == 'oneway':
                            df1 = n_groups - 1
                            df2 = n_val - n_groups
                            ncp = (effect_size ** 2) * n_val
                            f_crit = stats.f.ppf(1 - alpha, df1, df2)
                            powers.append(stats.ncf.sf(f_crit, df1, df2, ncp))
                            
                        elif plot_anova_mode == 'factorial':
                            df_num = plot_params['df_num']
                            df_denom = n_val - n_groups
                            ncp = (effect_size ** 2) * n_val
                            f_crit = stats.f.ppf(1 - alpha, df_num, df_denom)
                            powers.append(stats.ncf.sf(f_crit, df_num, df_denom, ncp))
                            
                        elif plot_anova_mode == 'rm':
                            m_reps = plot_params['m_reps']
                            epsilon = plot_params['epsilon']
                            df1 = (m_reps - 1) * epsilon
                            df2 = (n_val - n_groups) * (m_reps - 1) * epsilon
                            ncp = (effect_size ** 2) * n_val * epsilon
                            f_crit = stats.f.ppf(1 - alpha, df1, df2)
                            powers.append(stats.ncf.sf(f_crit, df1, df2, ncp))

                # Draw
                if len(powers) > 0:
                    ax.plot(ns, powers, color='#2563eb', linewidth=2, label=f'ES={effect_size}')
                    ax.axhline(y=target_power, color='r', linestyle='--', alpha=0.5, label='Target')
                    ax.axvline(x=n_result, color='g', linestyle='--', alpha=0.5, label='Result N')
                    ax.set_title(f'Power Curve', fontsize=10, fontweight='bold')
                    ax.set_xlabel('Sample Size (N)', fontsize=9)
                    ax.set_ylabel('Power', fontsize=9)
                    ax.grid(True, linestyle=':', alpha=0.6)
                    ax.legend(fontsize=8)
                    js.document.getElementById("plot-area").innerHTML = ""
                    display(fig, target="plot-area", append=False)
                    plt.close(fig)
                else:
                    # Use single quotes for outer string to handle double quotes inside HTML
                    js.document.getElementById("plot-area").innerHTML = '<p class="text-gray-400">Plot not available for this test type</p>'

            except Exception as e:
                error_div.style.display = "block"
                error_div.innerText = f"Error: {str(e)}"
                print(e)

        proxy_calc = create_proxy(run_analysis)
        js.document.getElementById("calc-btn").addEventListener("click", proxy_calc)

    </py-script>
</body>
</html>
